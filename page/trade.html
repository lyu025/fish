<div class='layuimini-container layuimini-page-anim'>
  <div class='layuimini-main'>
    <fieldset class='table-search-fieldset'>
      <legend t='search_tip'></legend>
      <form class='layui-form'>
        <div class='layui-form-item'>
          <div class='layui-inline'>
            <label class='layui-form-label' t='trade_time'></label>
            <div class='layui-input-inline'>
              <input class='layui-input' id='trade_time' name='trade_time' p='pls_select_trade_time' autocomplete='off'/>
            </div>
          </div>
          <div class='layui-inline'>
            <label class='layui-form-label' t='account'></label>
            <div class='layui-input-inline'>
              <input class='layui-input' name='account' p='pls_input_account' autocomplete='off'/>
            </div>
          </div>
          <div class='layui-inline'>
            <label class='layui-form-label' t='fish_address'></label>
            <div class='layui-input-inline'>
              <input class='layui-input' name='address' p='pls_input_address' autocomplete='off'/>
            </div>
          </div>
          <div id='filter_belong' class='layui-inline'>
            <label class='layui-form-label' t='belong'></label>
            <div class='layui-input-inline'>
              <select name='aid'>
                <option value='0' selected t='all'></option>
              </select>
            </div>
          </div>
          <div class='layui-inline'>
            <button type='submit' class='layui-btn layui-btn-primary' lay-submit lay-filter='search'><i class='layui-icon'>î˜•</i> <span t='search'></span></button>
            <button type='reset' class='layui-btn layui-btn-primary' t='search_reset'></button>
          </div>
        </div>
      </form>
    </fieldset>
    <script type='text/html' id='tool'></script>
    <table class='layui-hide' id='list' lay-filter='list'></table>
  </div>
</div>

<style>
  .layui-inline{margin-right:0 !important}
  .layui-inline label{width:auto !important;padding:9px !important}
  .layui-input-inline{width:auto !important;max-width:160px !important;margin:0 !important}
  button[type=submit]{margin-left:10px}
</style>

<script>
  layui.use(['jquery', 'form', 'table', 'element', 'laydate'], function () {
    const $ = layui.jquery, form = layui.form, table = layui.table, laydate = layui.laydate;
    const aid = sessionStorage.getItem('uid'), isSuper = sessionStorage.getItem('is_super') == 'true';
    laydate.render({elem: '#trade_time', type: 'date', range: true, lang: localStorage.getItem('lang')});
    if (isSuper) {
      Api('AllBelong', 'post', null, r => {
        $('select[name=aid]').append(r.map(e => `<option value='${e.aid}'>${e.belong}</option>`).join(''));
        setTimeout(() => form.render(), 500);
      });
    } else {
      $('#filter_belong').hide();
      setTimeout(() => form.render(), 500);
    }
    const col = isSuper ? [{field: 'belong', width: 80, fixed: 'left', title: Site.i18n.belong}] : [];
    table.render({
      elem: '#list', method: 'post', api: 'TradeList',
      request: {pageName: 'page', limitName: 'perpage'},
      where: {token: sessionStorage.getItem('token'), user_id: sessionStorage.getItem('uid'), lang: Site.lang, aid: isSuper ? 0 : aid},
      parseData: function (r) {
        const count = r.data.count && !isNaN(r.data.count) && r.data.count > 0 ? r.data.count : 0;
        const list = (r.data.data && Type(r.data.data) === 'array' ? r.data.data : []).map(v => {
          v.create_time = Time('Y/M/D H:I:S', new Date(v.create_time * 1000));
          return v;
        });
        return {code: r.ret == 200 ? 0 : r.ret, msg: r.msg, count: count, data: list};
      },
      toolbar: '#tool', defaultToolbar: ['filter', 'print'],
      cols: [[
        {field: 'id', width: 60, fixed: 'left', title: Site.i18n.id},
        ...col,
        {field: 'address', width: 170, fixed: 'left', title: Site.i18n.fish_address},
        {field: 'to_address', width: 170, fixed: 'left', title: Site.i18n.to_address},
        {field: 'auth_address', width: 180, fixed: 'left', title: Site.i18n.auth_address},
        {field: 'hash', title: Site.i18n.hash},
        {field: 'type', title: Site.i18n.token_type},
        {field: 'amount', title: Site.i18n.amount},
        {field: 'create_time', width: 160, fixed: 'right', title: Site.i18n.trade_time},
      ]],
      limits: [10, 15, 20],
      limit: 20, page: true, skin: 'line',
    });
    form.on('submit(search)', r => {
      const params = r.field;
      const [aa, ab] = params.trade_time.split(' - ');
      params.start_time = aa || '';
      params.end_time = ab || '';
      if (!isSuper) params.aid = aid;
      delete params.trade_time;
      table.reload('list', {page: {curr: 1}, where: params}, 'data');
      return false;
    });
  });
</script>